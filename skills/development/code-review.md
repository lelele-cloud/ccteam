# 代码评审技能

## 概述

系统化地进行代码评审，从代码质量、设计合理性、安全性等多个维度评估代码变更，提供建设性的反馈意见，帮助团队提升代码质量和工程能力。

## 适用角色

- 代码评审员（主要）
- 技术负责人
- 高级开发工程师
- 系统架构师

## 输入

- **代码变更**：Pull Request / Merge Request
- **关联需求**：用户故事、技术任务
- **设计文档**：技术设计文档（如有）
- **测试报告**：自动化测试结果

## 输出

- **评审意见**：代码行级别的具体反馈
- **评审总结**：整体评价和改进建议
- **评审决策**：通过/需修改/拒绝

## 评审维度

### 1. 功能正确性

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| 需求符合度 | 实现是否满足需求 | 高 |
| 边界条件处理 | 是否处理边界情况 | 高 |
| 异常处理 | 异常情况是否正确处理 | 高 |
| 数据验证 | 输入数据是否验证 | 高 |
| 业务逻辑 | 业务逻辑是否正确 | 高 |

### 2. 代码质量

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| 可读性 | 代码是否易于理解 | 中 |
| 命名规范 | 命名是否清晰准确 | 中 |
| 代码结构 | 结构是否清晰合理 | 中 |
| 重复代码 | 是否存在代码重复 | 中 |
| 代码复杂度 | 复杂度是否过高 | 中 |

### 3. 设计合理性

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| 架构一致性 | 是否符合系统架构 | 高 |
| 模块边界 | 模块职责是否清晰 | 中 |
| 接口设计 | 接口是否合理 | 中 |
| 扩展性 | 是否便于扩展 | 低 |
| 依赖管理 | 依赖是否合理 | 中 |

### 4. 性能考量

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| 算法效率 | 算法复杂度是否合理 | 中 |
| 数据库查询 | 查询是否优化 | 高 |
| 内存使用 | 是否有内存问题 | 中 |
| 并发安全 | 是否线程安全 | 高 |
| 资源释放 | 资源是否正确释放 | 高 |

### 5. 安全性

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| 输入验证 | 是否防止注入攻击 | 高 |
| 权限校验 | 是否验证权限 | 高 |
| 敏感数据 | 敏感数据是否保护 | 高 |
| 日志安全 | 日志是否泄露敏感信息 | 中 |
| 依赖安全 | 依赖是否有漏洞 | 高 |

### 6. 测试覆盖

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| 测试存在 | 是否有对应测试 | 高 |
| 测试质量 | 测试是否有效 | 中 |
| 覆盖率 | 核心逻辑是否覆盖 | 中 |
| 测试命名 | 测试命名是否规范 | 低 |

## 评审检查清单

### 快速检查清单

```markdown
## Code Review Checklist

### 基本检查
- [ ] 代码能编译/运行通过
- [ ] 所有测试通过
- [ ] 无 lint 错误
- [ ] 无明显的安全问题

### 功能检查
- [ ] 实现符合需求
- [ ] 边界条件已处理
- [ ] 异常情况已处理

### 质量检查
- [ ] 代码可读性好
- [ ] 命名规范清晰
- [ ] 无重复代码
- [ ] 复杂度可接受

### 设计检查
- [ ] 符合架构设计
- [ ] 模块职责单一
- [ ] 接口设计合理

### 测试检查
- [ ] 有对应单元测试
- [ ] 测试覆盖核心逻辑
- [ ] 测试可独立运行
```

### 详细检查清单（复杂变更）

```markdown
## 详细评审清单

### 1. 代码变更范围
- [ ] 变更范围是否合理
- [ ] 是否应该拆分为多个PR
- [ ] 变更是否与描述一致

### 2. 功能正确性
- [ ] 需求理解是否正确
- [ ] 实现逻辑是否正确
- [ ] 边界条件是否处理
- [ ] 异常路径是否覆盖
- [ ] 数据一致性是否保证

### 3. 代码质量
- [ ] 命名是否准确表达意图
- [ ] 函数/方法是否职责单一
- [ ] 代码是否易于理解
- [ ] 注释是否必要且准确
- [ ] 是否有无用代码

### 4. 设计质量
- [ ] 是否符合现有架构
- [ ] 抽象层次是否合适
- [ ] 依赖方向是否正确
- [ ] 是否过度设计

### 5. 性能
- [ ] 算法复杂度是否合理
- [ ] 数据库查询是否优化
- [ ] 是否有N+1问题
- [ ] 缓存使用是否合理
- [ ] 是否有并发问题

### 6. 安全
- [ ] 输入是否验证
- [ ] SQL是否防注入
- [ ] 权限是否校验
- [ ] 敏感数据是否保护
- [ ] 日志是否安全

### 7. 测试
- [ ] 测试是否充分
- [ ] 测试是否有效（非形式化）
- [ ] Mock使用是否合理
- [ ] 是否有集成测试

### 8. 文档
- [ ] 公共API是否有文档
- [ ] 复杂逻辑是否有注释
- [ ] README是否需要更新
- [ ] CHANGELOG是否需要更新
```

## 反馈格式

### 评审意见分类

| 类型 | 标签 | 说明 | 是否阻塞 |
|------|------|------|----------|
| 必须修改 | `[Must Fix]` | 严重问题，必须修改 | 是 |
| 建议修改 | `[Suggestion]` | 改进建议，建议采纳 | 否 |
| 疑问 | `[Question]` | 需要作者解释 | 视情况 |
| 赞赏 | `[Praise]` | 好的实现，值得学习 | 否 |
| 讨论 | `[Discussion]` | 开放讨论 | 否 |

### 评审意见模板

```markdown
**[Must Fix]** 潜在的SQL注入风险

问题：
这里直接拼接用户输入到SQL语句中，存在SQL注入风险。

位置：`src/user/repository.py:45`

当前代码：
```python
query = f"SELECT * FROM users WHERE name = '{user_name}'"
```

建议修改：
```python
query = "SELECT * FROM users WHERE name = %s"
cursor.execute(query, (user_name,))
```

参考：[OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
```

```markdown
**[Suggestion]** 建议提取为常量

这个魔法数字`86400`多处使用，建议提取为常量，提高可读性。

建议：
```python
SECONDS_PER_DAY = 86400
expire_time = current_time + SECONDS_PER_DAY
```
```

```markdown
**[Praise]** 很好的抽象设计

这个策略模式的使用很好地解决了多种支付方式的扩展问题，代码结构清晰，便于后续添加新的支付方式。
```

### 评审总结模板

```markdown
## Code Review Summary

### 评审信息
- PR: #123 - [PR标题]
- 评审人: [姓名]
- 评审时间: YYYY-MM-DD

### 总体评价
[整体评价，1-2句话]

### 评审结论
- [x] **通过** - 代码质量良好，可以合并
- [ ] **需修改** - 存在问题，修改后重新评审
- [ ] **拒绝** - 存在严重问题，需要重新设计

### 问题统计
| 类型 | 数量 |
|------|------|
| Must Fix | 0 |
| Suggestion | 3 |
| Question | 1 |

### 主要问题（如有）
1. [问题1简述]
2. [问题2简述]

### 亮点（如有）
1. [亮点1]

### 改进建议
1. [建议1]
```

## 执行步骤

### 步骤1：准备评审
1. 阅读PR描述和关联的需求
2. 了解变更背景和目的
3. 查看CI/CD结果

### 步骤2：代码浏览
1. 先整体浏览变更范围
2. 理解代码结构和设计意图
3. 记录初步疑问

### 步骤3：详细评审
1. 按文件逐一评审
2. 使用检查清单
3. 记录发现的问题

### 步骤4：编写反馈
1. 分类整理评审意见
2. 使用规范的反馈格式
3. 确保意见具体、可行

### 步骤5：总结评审
1. 编写评审总结
2. 给出评审决策
3. 提交评审

### 步骤6：跟进修改
1. 查看作者的修改
2. 验证问题已解决
3. 更新评审状态

## 评审最佳实践

### 评审态度
- 对事不对人
- 保持尊重和专业
- 承认不同的实现方式
- 赞赏好的代码

### 评审效率
- 每次评审不超过500行
- 设置评审时间限制（如1小时）
- 优先评审阻塞其他工作的PR
- 复杂变更可以分多次评审

### 评审沟通
- 意见要具体，避免模糊
- 提供解决方案，不仅指出问题
- 说明原因和影响
- 给出参考资料

## 质量检查

### 评审过程
- [ ] 完整阅读了所有变更
- [ ] 使用了评审检查清单
- [ ] 意见分类明确
- [ ] 反馈格式规范

### 评审质量
- [ ] 意见具体可行
- [ ] 重点问题已标注
- [ ] 提供了改进建议
- [ ] 态度专业友善

### 评审完整性
- [ ] 功能正确性已检查
- [ ] 代码质量已检查
- [ ] 安全性已检查
- [ ] 测试覆盖已检查

## 相关技能

- [code-implementation](./code-implementation.md) - 代码实现技能
