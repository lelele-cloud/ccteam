# 安全审计技能

## 概述

系统化执行安全审计，从威胁建模到渗透测试，识别系统安全风险并提供修复建议。遵循OWASP安全标准，确保应用安全。

## 适用角色

- 安全工程师（主要）
- 技术负责人
- 后端工程师
- 架构师

## 输入

- **系统架构**：架构设计文档、系统部署图
- **代码仓库**：源代码访问权限
- **接口文档**：API文档、OpenAPI规范
- **测试环境**：可用于安全测试的环境

## 输出

- **安全审计报告**：`docs/ccteam/08-testing/security-report.md`
- **漏洞清单**：`docs/ccteam/08-testing/vulnerabilities.md`
- **修复建议**：针对每个漏洞的修复方案
- **安全规范**：`docs/ccteam/security-guidelines.md`

## 执行步骤

### 步骤1：威胁建模

1. **资产识别**
   ```markdown
   ## 资产清单

   | 资产类型 | 资产名称 | 敏感级别 | 说明 |
   |----------|----------|----------|------|
   | 数据 | 用户密码 | 高 | 哈希存储 |
   | 数据 | 用户邮箱 | 中 | PII |
   | 数据 | 订单信息 | 高 | 业务核心 |
   | 服务 | API服务 | 高 | 对外暴露 |
   | 服务 | 数据库 | 高 | 核心存储 |
   ```

2. **攻击面分析**
   ```
   外部攻击面：
   ├── Web应用入口
   │   ├── 用户输入（表单、URL参数、Header）
   │   ├── 文件上传
   │   └── API接口
   ├── 认证入口
   │   ├── 登录接口
   │   ├── 注册接口
   │   └── 密码重置
   └── 第三方集成
       ├── OAuth回调
       └── Webhook

   内部攻击面：
   ├── 服务间通信
   ├── 数据库访问
   └── 管理接口
   ```

3. **威胁识别（STRIDE模型）**
   | 威胁类型 | 说明 | 示例 |
   |----------|------|------|
   | Spoofing | 身份伪造 | 伪造Token |
   | Tampering | 数据篡改 | 修改订单金额 |
   | Repudiation | 抵赖 | 否认操作 |
   | Information Disclosure | 信息泄露 | 敏感数据暴露 |
   | Denial of Service | 拒绝服务 | 资源耗尽 |
   | Elevation of Privilege | 权限提升 | 越权访问 |

### 步骤2：代码审计

1. **静态代码分析**
   ```bash
   # JavaScript/TypeScript
   npm audit
   npx eslint --ext .js,.ts src/

   # Python
   pip-audit
   bandit -r src/

   # Go
   gosec ./...

   # 通用
   semgrep --config=auto .
   ```

2. **人工代码审查清单**

   **认证相关**
   - [ ] 密码存储使用安全哈希（bcrypt/Argon2）
   - [ ] Token生成使用安全随机
   - [ ] 会话管理安全
   - [ ] 多因素认证实现正确

   **授权相关**
   - [ ] 每个接口都有权限检查
   - [ ] 防止水平越权（检查资源所属）
   - [ ] 防止垂直越权（检查角色权限）
   - [ ] 敏感操作二次验证

   **输入处理**
   - [ ] 所有输入都有验证
   - [ ] SQL使用参数化查询
   - [ ] 命令执行避免拼接
   - [ ] 文件路径防止遍历

   **输出处理**
   - [ ] HTML输出编码（防XSS）
   - [ ] JSON响应Content-Type正确
   - [ ] 错误信息不泄露敏感信息
   - [ ] 日志不记录敏感数据

3. **依赖漏洞检查**
   ```bash
   # 检查并修复
   npm audit fix

   # 生成报告
   npm audit --json > audit-report.json
   ```

### 步骤3：渗透测试

1. **OWASP Top 10测试**

   **A01: 访问控制失效**
   ```
   测试项：
   - [ ] 越权访问测试（修改ID访问他人资源）
   - [ ] 权限绕过测试（直接访问管理接口）
   - [ ] CORS配置测试
   - [ ] JWT/Token篡改测试
   ```

   **A02: 加密失败**
   ```
   测试项：
   - [ ] 敏感数据是否加密传输（HTTPS）
   - [ ] 敏感数据是否加密存储
   - [ ] 使用的加密算法是否安全
   - [ ] 密钥管理是否安全
   ```

   **A03: 注入**
   ```
   测试项：
   - [ ] SQL注入测试
   - [ ] NoSQL注入测试
   - [ ] 命令注入测试
   - [ ] LDAP注入测试
   - [ ] XPath注入测试
   ```

   **A07: 跨站脚本(XSS)**
   ```
   测试项：
   - [ ] 反射型XSS测试
   - [ ] 存储型XSS测试
   - [ ] DOM型XSS测试

   测试向量：
   <script>alert('XSS')</script>
   <img src=x onerror=alert('XSS')>
   javascript:alert('XSS')
   ```

2. **业务逻辑测试**
   ```
   测试场景：
   - [ ] 价格篡改（修改金额参数）
   - [ ] 数量篡改（负数、超大数）
   - [ ] 流程绕过（跳过支付步骤）
   - [ ] 竞态条件（并发请求）
   - [ ] 重放攻击（重复提交）
   ```

3. **测试工具使用**
   ```
   自动化扫描：
   - OWASP ZAP: 综合Web漏洞扫描
   - Burp Suite: 代理和手动测试
   - SQLMap: SQL注入自动化
   - Nuclei: 漏洞模板扫描

   命令示例：
   # ZAP快速扫描
   zap-cli quick-scan -s xss,sqli http://target.com

   # SQLMap测试
   sqlmap -u "http://target.com/api?id=1" --batch

   # Nuclei扫描
   nuclei -u http://target.com -t cves/
   ```

### 步骤4：报告输出

1. **漏洞报告格式**
   ```markdown
   ## 漏洞报告

   ### 基本信息
   - 漏洞ID: VULN-2024-001
   - 漏洞名称: SQL注入漏洞
   - 严重等级: 高危
   - CVSS评分: 8.5
   - 发现时间: 2024-01-15
   - 发现者: 安全团队

   ### 漏洞描述
   在用户查询接口(/api/users)中存在SQL注入漏洞，
   攻击者可以通过构造恶意参数获取数据库敏感信息。

   ### 影响范围
   - 影响系统: 用户管理模块
   - 影响版本: v1.0.0 - v1.2.0
   - 潜在影响: 数据泄露、数据篡改

   ### 复现步骤
   1. 访问 /api/users?id=1
   2. 将id参数修改为 1' OR '1'='1
   3. 观察返回所有用户数据

   ### 修复建议
   1. 使用参数化查询替代字符串拼接
   2. 添加输入验证
   3. 实施最小权限原则

   ### 参考资料
   - OWASP SQL Injection: https://owasp.org/...
   - CWE-89: https://cwe.mitre.org/...
   ```

2. **安全审计报告格式**
   ```markdown
   # 安全审计报告

   ## 1. 概述
   - 审计对象: XXX系统
   - 审计时间: 2024-01-15 至 2024-01-20
   - 审计范围: Web应用、API接口
   - 审计方法: 代码审计 + 渗透测试

   ## 2. 风险统计
   | 风险等级 | 数量 |
   |----------|------|
   | 严重 | 0 |
   | 高危 | 2 |
   | 中危 | 5 |
   | 低危 | 8 |

   ## 3. 漏洞详情
   [各漏洞详细信息]

   ## 4. 修复建议
   [修复优先级和建议]

   ## 5. 安全建议
   [整体安全改进建议]
   ```

## 质量检查

### 审计覆盖检查
- [ ] 认证机制已审计
- [ ] 授权机制已审计
- [ ] 输入处理已审计
- [ ] 数据保护已审计
- [ ] 配置安全已审计

### OWASP Top 10检查
- [ ] A01: 访问控制失效
- [ ] A02: 加密机制失效
- [ ] A03: 注入
- [ ] A04: 不安全设计
- [ ] A05: 安全配置错误
- [ ] A06: 易受攻击和过时的组件
- [ ] A07: 身份识别和认证失败
- [ ] A08: 软件和数据完整性故障
- [ ] A09: 安全日志和监控失效
- [ ] A10: 服务器端请求伪造

### 报告质量检查
- [ ] 漏洞描述清晰
- [ ] 复现步骤完整
- [ ] 风险评估准确
- [ ] 修复建议可操作
- [ ] 优先级排序合理

## 常见问题与解决方案

| 问题 | 解决方案 |
|------|----------|
| 测试环境不稳定 | 使用独立测试环境，测试前确认可用 |
| 漏洞无法复现 | 记录详细环境信息，多次验证 |
| 误报过多 | 人工验证自动化扫描结果 |
| 修复验证困难 | 保留测试用例，修复后重新执行 |

## 安全审计报告模板

```markdown
# ${PROJECT_NAME} 安全审计报告

## 审计概要

| 项目 | 内容 |
|------|------|
| 审计对象 | ${SYSTEM_NAME} |
| 审计范围 | ${SCOPE} |
| 审计时间 | ${DATE_RANGE} |
| 审计人员 | ${AUDITOR} |

## 风险统计

| 等级 | 数量 | 已修复 | 待修复 |
|------|------|--------|--------|
| 严重 | 0 | 0 | 0 |
| 高危 | 0 | 0 | 0 |
| 中危 | 0 | 0 | 0 |
| 低危 | 0 | 0 | 0 |

## 漏洞清单

| ID | 名称 | 等级 | 状态 |
|----|------|------|------|
| VULN-001 | xxx | 高危 | 待修复 |

## 修复建议

[按优先级排列的修复建议]

## 附录

- 测试工具清单
- 测试用例详情
```

## 相关技能

- [system-design](../architecture/system-design.md) - 系统设计技能
- [code-review](../development/code-review.md) - 代码审查技能
